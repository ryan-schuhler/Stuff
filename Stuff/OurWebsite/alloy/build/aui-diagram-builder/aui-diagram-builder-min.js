AUI.add("aui-diagram-builder-base",function(ag){var W=ag.Lang,d=W.isArray,aw=W.isBoolean,N=W.isNumber,E=W.isObject,aA=W.isString,L=function(A){return ag.instanceOf(A,ag.ArrayList);},U=function(A){return ag.instanceOf(A,ag.Node);},G=function(A){return ag.instanceOf(A,ag.AvailableField);},aJ=ag.Array,X="add",n="addNode",aI="auto",O="availableField",S="availableFields",aF="availableFieldsDragConfig",u="boundingBox",aC="builder",ab="cancel",ad="canvas",ay="clearfix",f="column",a="container",ae="content",x="contentBox",e="contentContainer",R="contentNode",H="createDocumentFragment",C="diagram",an="diagram-builder",q="draggable",aE="drop",aq="dropConfig",aa="dropContainer",av="field",v="fields",p="fieldsContainer",au="height",r="helper",Z="icon",y="iconClass",ap="id",ak="label",w="layout",ao="list",Q="maxFields",t="node",g="parentNode",af="propertyList",aD="rendered",ar="save",s="settings",P="tab",J="tabView",b="tabs",h="tabview",al="title",M="toolbar",m="toolbarContainer",B=ag.getClassName,aH=" ",i=".",j="#",D="_",z=B(C,aC,ad),ah=B(C,aC,ae,a),F=B(C,aC,aE,a),ax=B(C,aC,av),l=B(C,aC,av,q),c=B(C,aC,av,Z),ac=B(C,aC,av,ak),Y=B(C,aC,v,a),ai=B(C,aC,P,X),K=B(C,aC,P,s),at=B(C,aC,b),T=B(C,aC,b,ae),am=B(C,aC,M,a),aj=B(r,ay),o=B(Z),I=B(w),aB=B(h,ae),aG=B(h,ao);var k=ag.Component.create({NAME:O,ATTRS:{draggable:{value:true,validator:aw},label:{validator:aA},iconClass:{validator:aA},id:{value:ag.guid(),setter:"_setId",validator:aA},node:{valueFn:function(aK){var A=this;if(!U(aK)){aK=ag.Node.create(ag.Lang.sub(A.FIELD_ITEM_TEMPLATE,{iconClass:A.get(y)}));aK.setData(O,A);}return aK;},validator:U,writeOnce:true},type:{value:t,validator:aA}},EXTENDS:ag.Base,buildNodeId:function(A){return S+D+av+D+A;},getAvailableFieldById:function(A){return ag.AvailableField.getAvailableFieldByNode(j+ag.AvailableField.buildNodeId(A));},getAvailableFieldByNode:function(A){A=ag.one(A);if(U(A)){return A.getData(O);}return null;},prototype:{FIELD_ITEM_TEMPLATE:'<li class="'+ax+'">'+'<span class="'+[o,c].join(aH)+' {iconClass}"></span>'+'<div class="'+ac+'"></div>'+"</li>",initializer:function(){var A=this;var aK=A.get(t);A.after({draggableChange:A._afterDraggableChange,idChange:A._afterIdChange,labelChange:A._afterLabelChange});A.labelNode=aK.one(i+ac);A._uiSetDraggable(A.get(q));A._uiSetId(A.get(ap));A._uiSetLabel(A.get(ak));},_afterDraggableChange:function(aK){var A=this;A._uiSetDraggable(aK.newVal);},_afterIdChange:function(aK){var A=this;A._uiSetId(aK.newVal);},_afterLabelChange:function(aK){var A=this;A._uiSetLabel(aK.newVal);},_setId:function(A){return ag.AvailableField.buildNodeId(A);},_uiSetDraggable:function(aK){var A=this;A.get(t).toggleClass(l,aK);},_uiSetId:function(aK){var A=this;A.get(t).set(ap,aK);},_uiSetLabel:function(aK){var A=this;A.get(t).attr(al,aK);A.labelNode.setContent(aK);}}});ag.AvailableField=k;var V=function(){};V.ATTRS={fields:{value:[],setter:"_setFields",validator:function(A){return d(A)||L(A);}},maxFields:{value:Infinity,validator:N}};ag.mix(V.prototype,{_setFields:function(aK){var A=this;if(L(aK)){return aK;}else{return A.createFields(aK);}},_updateFields:function(aK){var A=this;A.set(v,aK);},addField:function(aL,aK){var A=this;if(A.get(v).size()<A.get(Q)){var aM=A.createField(aL);if(aM){A._updateFields(A.get(v).add(aM,aK));}return aM;}return null;},createFields:function(aL){var aK=this;var A=[];aJ.each(aL,function(aN,aM){if(aM<aK.get(Q)){A.push(aK.createField(aN));}});return new ag.ArrayList(A);},removeField:function(aK){var A=this;A._updateFields(A.get(v).remove(aK));},createField:function(A){return A;}});ag.FieldSupport=V;var az=ag.Component.create({NAME:an,ATTRS:{availableFields:{setter:"_setAvailableFields",validator:d},availableFieldsDragConfig:{value:null,setter:"_setAvailableFieldsDragConfig",validator:E},canvas:{valueFn:function(){return ag.Node.create(this.CANVAS_TEMPLATE);}},dropConfig:{value:null,setter:"_setDropConfig",validator:E},contentContainer:{valueFn:function(){return ag.Node.create(this.CONTENT_CONTAINER_TEMPLATE);}},dropContainer:{valueFn:function(){return ag.Node.create(this.DROP_CONTAINER_TEMPLATE);}},fieldsContainer:{valueFn:function(){return ag.Node.create(this.FIELDS_CONTAINER_TEMPLATE);}},propertyList:{setter:"_setPropertyList",validator:E,value:null},strings:{value:{addNode:"Add node",cancel:"Cancel",propertyName:"Property Name",save:"Save",settings:"Settings",value:"Value"}},tabView:{setter:"_setTabView",validator:E,value:null,writeOnce:true},toolbar:{setter:"_setToolbar",validator:E,value:null},toolbarContainer:{valueFn:function(){return ag.Node.create(this.TOOLBAR_CONTAINER_TEMPLATE);}}},HTML_PARSER:{contentContainer:i+ah,dropContainer:i+F,fieldsContainer:i+Y,toolbarContainer:i+am,canvas:i+z},UI_ATTRS:[S,v],AUGMENTS:[ag.FieldSupport],prototype:{CONTENT_CONTAINER_TEMPLATE:'<div class="'+ah+'"></div>',DROP_CONTAINER_TEMPLATE:'<div class="'+F+'"></div>',TOOLBAR_CONTAINER_TEMPLATE:'<div class="'+am+'"></div>',FIELDS_CONTAINER_TEMPLATE:'<ul class="'+[Y,aj].join(aH)+'"></ul>',CANVAS_TEMPLATE:'<div tabindex="1" class="'+z+'"></div>',fieldsNode:null,propertyList:null,settingsNode:null,tabView:null,toolbar:null,initializer:function(){var A=this;A.publish({cancel:{defaultFn:A._defCancelFn}});A.after({render:A._afterRender,"model:change":A._afterModelChange});A.after(A._afterUiSetHeight,A,"_uiSetHeight");A.canvas=A.get(ad);A.contentContainer=A.get(e);A.dropContainer=A.get(aa);A.fieldsContainer=A.get(p);A.toolbarContainer=A.get(m);},isAvailableFieldsDrag:function(aL){var A=this;var aK=A.availableFieldsDrag;return(aL===aK.dd);},plotFields:function(){var aK=this;var A=aK.get(v);A.each(function(aL){aK.plotField(aL);});},renderUI:function(){var A=this;A._renderTabs();A._renderCanvas();A._uiSetAvailableFields(A.get(S));},syncUI:function(){var A=this;var aK=A.get(x);A._setupDrop();A._setupAvailableFieldsDrag();aK.addClass(I);},_afterActiveTabChange:function(aL){var A=this;var aK=aL.newVal.get(R);if(A.get(aD)&&(aK===A.settingsNode)){A._renderSettings();}},_afterModelChange:function(aK){var A=this;
A._handleSaveEvent();},_afterRender:function(aK){var A=this;A.plotFields();},_afterUiSetHeight:function(aK){var A=this;A.contentContainer.setStyle(au,N(aK)?aK+A.DEF_UNIT:aK);A.dropContainer.setStyle(au,N(aK)?aK+A.DEF_UNIT:aK);},_defCancelFn:function(aK){var A=this;A.tabView.selectTab(0);},_handleCancelEvent:function(){var A=this;A.fire(ab);},_handleSaveEvent:function(){var A=this;A.fire(ar);},_renderCanvas:function(){var A=this;var aK=A.get(x);var aL=A.canvas;var aM=A.contentContainer;var aN=A.dropContainer;if(!aL.inDoc()){aM.appendChild(aL);}if(!aN.inDoc()){aL.appendChild(aN);}if(aM.inDoc()){aM.get(g).append(aM);}else{aK.appendChild(aM);}},_renderPropertyList:function(){var A=this;if(!A.propertyList){A.propertyList=new ag.PropertyList(A.get(af)).render(A.settingsNode);A.propertyList.get(u).unselectable();}},_renderSettings:function(){var A=this;A._renderPropertyList();A._renderToolbar();},_renderTabs:function(){var A=this;if(!A.tabView){var aK=new ag.TabView(A.get(J));aK.get(u);A.tabView=aK;A.fieldsNode=aK.getTab(0).get(R);A.settingsNode=aK.getTab(1).get(R);}},_renderToolbar:function(){var A=this;if(!A.toolbar){A.toolbar=new ag.Toolbar(A.get(M)).render(A.settingsNode);}},_setupDrop:function(){var A=this;A.drop=new ag.DD.Drop(A.get(aq));},_setupAvailableFieldsDrag:function(){var A=this;A.availableFieldsDrag=new ag.DD.Delegate(A.get(aF));},_setAvailableFields:function(aL){var aK=this;var A=[];aJ.each(aL,function(aN,aM){A.push(G(aN)?aN:new ag.AvailableField(aN));});return A;},_setDropConfig:function(aK){var A=this;return ag.merge({bubbleTargets:A,groups:[S],node:A.dropContainer},aK||{});},_setAvailableFieldsDragConfig:function(aK){var A=this;return ag.merge({bubbleTargets:A,container:A.get(u),dragConfig:{groups:[S],plugins:[{cfg:{moveOnEnd:false},fn:ag.Plugin.DDProxy}]},nodes:i+l},aK||{});},_setPropertyList:function(aK){var A=this;return ag.merge({bubbleTargets:A,width:250,scroll:{height:400,width:aI}},aK);},_setTabView:function(aN){var aK=this;var aM=aK.get(u);var aO=aM.one(i+aG);var aL={after:{activeTabChange:ag.bind(aK._afterActiveTabChange,aK)},boundingBox:aM.one(i+at),contentBox:aM.one(i+T),bubbleTargets:aK,contentNode:aM.one(i+aB),cssClass:at,listNode:aO,render:aK.get(x)};if(!aO){var A=aK.getStrings();aL.items=[{cssClass:ai,label:A[n]},{cssClass:K,label:A[s]}];}return ag.merge(aL,aN);},_setToolbar:function(aL){var aK=this;var A=aK.getStrings();return ag.merge({activeState:false,bubbleTargets:aK,children:[{handler:ag.bind(aK._handleCancelEvent,aK),label:A[ab]}]},aL);},_uiSetAvailableFields:function(aM){var A=this;var aL=A.fieldsNode;if(aL){var aK=ag.getDoc().invoke(H);aJ.each(aM,function(aN){aK.appendChild(aN.get(t));});aL.setContent(A.fieldsContainer.setContent(aK));}},_uiSetFields:function(aK){var A=this;if(A.get(aD)){A.plotFields();}}}});ag.DiagramBuilderBase=az;},"@VERSION@",{skinnable:true,requires:["aui-tabs","aui-property-list","collection","dd"]});AUI.add("aui-diagram-builder-impl",function(aB){var ar=aB.Lang,d=ar.isArray,a0=ar.isBoolean,N=ar.isObject,a5=ar.isString,aw=aB.WidgetStdMod,bg=aB.Array,ap="activeElement",a2="attributeName",ac="availableField",af="availableFields",E="backspace",an="boolean",y="boundary",s="boundingBox",bc="builder",av="cancel",ax="canvas",aQ="click",a6="closeEvent",K="closeMessage",a8="condition",S="connector",m="connectors",az="content",V="controls",aN="controlsToolbar",T="createDocumentFragment",aL="data",W="data-nodeId",ah="delete",aJ="deleteConnectorsMessage",q="deleteNodesMessage",aT="description",L="diagram",ay="diagram-builder",aF="diagramNode",a9="diagram-node-manager",G="diagram-node",aX="dragNode",ae="dragging",H="editEvent",Q="editMessage",X="editing",aS="end",a="esc",aZ="field",t="fields",aD="fieldsDragConfig",aA="fork",al="graphic",aY="height",aH="highlightBoundaryStroke",R="highlightDropZones",c="highlighted",aP="id",v="join",Z="keydown",aC="label",B="lock",u="mouseenter",ao="mouseleave",p="name",r="node",aI="p1",aG="p2",f="parentNode",n="pencil",aM="radius",k="region",bd="rendered",P="required",a4="selected",aW="shape",ag="shapeBoundary",j="shapeInvite",O="showSuggestConnector",Y="source",aK="start",am="state",x="stroke",aV="suggest",aO="suggestConnectorOverlay",l="target",J="task",o="transition",ab="transitions",g="type",bb="value",at="visible",U="width",D="xy",C="zIndex",bf="-",i=".",aa="",h="#",M="_",z=aB.getClassName,w=z(L,bc,V),a3=z(L,bc,aZ),aq=z(L,r),b=z(L,r,az),aR=z(L,r,X),ad=z(L,r,aC),be=z(L,r,a4),aU=z(L,r,aW,y),e=z(L,r,aV,S),au=function(bj,A){var bi=d(bj)?bj:bj.get(s).getXY();return[bi[0]+A[0],bi[1]+A[1]];},ba=function(bk,bj){var bi=bj[0]-bk[0],A=bj[1]-bk[1];return Math.sqrt(bi*bi+A*A);},ak=function(bs,bq){var bo=bs.hotPoints,bn=bq.hotPoints,bv=bs.get(s).getXY(),bt=bq.get(s).getXY(),bk,bi,bl,bj,bu=Infinity,bm=[[0,0],[0,0]];for(bl=0,bk=bo.length;bl<bk;bl++){var br=bo[bl],bx=au(bv,br);for(bj=0,bi=bn.length;bj<bi;bj++){var bp=bn[bj],bw=au(bt,bp),A=ba(bw,bx);if(A<bu){bm[0]=br;bm[1]=bp;bu=A;}}}return bm;},aE=function(A,bj){var bi=d(bj)?bj:bj.getXY();var bk=d(A)?A:A.getXY();return bg.map(bk,function(bm,bl){return Math.max(0,bm-bi[bl]);});},I=function(A){return aB.instanceOf(A,aB.Connector);},a7=function(A){return aB.instanceOf(A,aB.DataSet);},ai=function(A){return aB.instanceOf(A,aB.DiagramBuilderBase);},a1=function(A){return aB.instanceOf(A,aB.DiagramNode);};var F=aB.Component.create({NAME:ay,ATTRS:{connector:{setter:"_setConnector",value:null},fieldsDragConfig:{value:null,setter:"_setFieldsDragConfig",validator:N},graphic:{valueFn:function(){return new aB.Graphic();},validator:N},highlightDropZones:{validator:a0,value:true},strings:{value:{addNode:"Add node",cancel:"Cancel",deleteConnectorsMessage:"Are you sure you want to delete the selected connector(s)?",deleteNodesMessage:"Are you sure you want to delete the selected node(s)?",propertyName:"Property Name",save:"Save",settings:"Settings",value:"Value"}},showSuggestConnector:{validator:a0,value:true},suggestConnectorOverlay:{value:null,setter:"_setSuggestConnectorOverlay"}},EXTENDS:aB.DiagramBuilderBase,FIELDS_TAB:0,SETTINGS_TAB:1,prototype:{editingConnector:null,editingNode:null,publishedSource:null,publishedTarget:null,selectedConnector:null,selectedNode:null,initializer:function(){var A=this;
A.after({render:A.syncConnectionsUI});A.on({cancel:A._onCancel,"drag:drag":A._onDrag,"drag:end":A._onDragEnd,"drop:hit":A._onDropHit,save:A._onSave});aB.DiagramNodeManager.on({publishedSource:function(bi){A.publishedTarget=null;A.publishedSource=bi.publishedSource;}});A.handlerKeyDown=aB.getDoc().on(Z,aB.bind(A._afterKeyEvent,A));A.dropContainer.delegate(aQ,aB.bind(A._onNodeClick,A),i+aq);A.dropContainer.delegate(u,aB.bind(A._onNodeMouseEnter,A),i+aq);A.dropContainer.delegate(ao,aB.bind(A._onNodeMouseLeave,A),i+aq);},renderUI:function(){var A=this;aB.DiagramBuilder.superclass.renderUI.apply(this,arguments);A._renderGraphic();},syncUI:function(){var A=this;aB.DiagramBuilder.superclass.syncUI.apply(this,arguments);A._setupFieldsDrag();A.connector=A.get(S);},syncConnectionsUI:function(){var A=this;A.get(t).each(function(bi){bi.syncConnectionsUI();});},clearFields:function(){var bi=this;var A=[];bi.get(t).each(function(bj){A.push(bj);});bg.each(A,function(bj){bj.destroy();});A=bi.editingConnector=bi.editingNode=bi.selectedNode=null;},closeEditProperties:function(){var A=this;var bi=A.editingNode;var bj=A.tabView;bj.selectTab(aB.DiagramBuilder.FIELDS_TAB);bj.disableTab(aB.DiagramBuilder.SETTINGS_TAB);if(bi){bi.get(s).removeClass(aR);}A.editingConnector=A.editingNode=null;},connect:function(bi,bk,bj){var A=this;if(a5(bi)){bi=bh.getNodeByName(bi);}if(a5(bk)){bk=bh.getNodeByName(bk);}if(bi&&bk){bi.connect(bk.get(p),bj);}return A;},connectAll:function(bi){var A=this;bg.each(bi,function(bj){if(bj.hasOwnProperty(Y)&&bj.hasOwnProperty(l)){A.connect(bj.source,bj.target,bj.connector);}});return A;},createField:function(bi){var A=this;if(!a1(bi)){bi.builder=A;bi.bubbleTargets=A;bi=new (A.getFieldClass(bi.type||r))(bi);}return bi;},deleteSelectedConnectors:function(){var bi=this;var A=bi.getStrings();var bj=bi.getSelectedConnectors();if(bj.length&&confirm(A[aJ])){bg.each(bj,function(bk){var bl=bk.get(o);aB.DiagramNode.getNodeByName(bl.source).disconnect(bl);});bi.stopEditing();}},deleteSelectedNode:function(){var bi=this;var A=bi.getStrings();var bj=bi.selectedNode;if(bj&&!bj.get(P)&&confirm(A[q])){bj.close();bi.editingNode=bi.selectedNode=null;bi.stopEditing();}},destructor:function(bi){var A=this;A.get(aO).destroy();},eachConnector:function(bi){var A=this;A.get(t).each(function(bj){bj.get(ab).each(function(bk){bi.call(A,bj.getConnector(bk),bk,bj);});});},editConnector:function(bi){var A=this;if(bi){var bj=A.tabView;A.closeEditProperties();bj.enableTab(aB.DiagramBuilder.SETTINGS_TAB);bj.selectTab(aB.DiagramBuilder.SETTINGS_TAB);A.propertyList.set(aL,bi.getProperties());A.editingConnector=A.selectedConnector=bi;}},editNode:function(bj){var A=this;if(bj){var bi=A.tabView;A.closeEditProperties();bi.enableTab(aB.DiagramBuilder.SETTINGS_TAB);bi.selectTab(aB.DiagramBuilder.SETTINGS_TAB);A.propertyList.set(aL,bj.getProperties());bj.get(s).addClass(aR);A.editingNode=A.selectedNode=bj;}},getFieldClass:function(bj){var A=this;var bi=aB.DiagramBuilder.types[bj];if(bi){return bi;}else{aB.log("The field type: ["+bj+"] couldn't be found.");return null;}},getNodesByTransitionProperty:function(bk,bj){var A=this;var bi=[];A.get(t).each(function(bl){bl.get(ab).each(function(bm){if(bm[bk]===bj){bi.push(bl);return false;}});});return bi;},getSelectedConnectors:function(){var A=this;var bi=[];A.eachConnector(function(bj){if(bj.get(a4)){bi.push(bj);}});return bi;},getSourceNodes:function(bi){var A=this;return A.getNodesByTransitionProperty(l,bi.get(p));},hideSuggestConnetorOverlay:function(bk,bi){var A=this;A.connector.hide();A.get(aO).hide();try{A.fieldsDrag.dd.set(B,false);}catch(bj){}},isAbleToConnect:function(){var A=this;return !!(A.publishedSource&&A.publishedTarget);},isFieldsDrag:function(bi){var A=this;return(bi===A.fieldsDrag.dd);},plotField:function(bi){var A=this;if(!bi.get(bd)){bi.render(A.dropContainer);}},select:function(bi){var A=this;A.unselectNodes();A.selectedNode=bi.set(a4,true).focus();},showSuggestConnetorOverlay:function(bj){var A=this;A.get(aO).set(D,bj||A.connector.get(aG)).show().get(s).addClass(e);try{A.fieldsDrag.dd.set(B,true);}catch(bi){}},stopEditing:function(){var A=this;A.unselectConnectors();A.unselectNodes();A.closeEditProperties();},toJSON:function(){var A=this;var bi={nodes:[]};A.get(t).each(function(bk){var bj={transitions:[]};bg.each(bk.SERIALIZABLE_ATTRS,function(bl){bj[bl]=bk.get(bl);});bk.get(ab).each(function(bm){var bl=bk.getConnector(bm);bm.connector=bl.toJSON();bj.transitions.push(bm);});bi.nodes.push(bj);});return bi;},unselectConnectors:function(){var A=this;bg.each(A.getSelectedConnectors(),function(bi){bi.set(a4,false);});},unselectNodes:function(){var A=this;var bi=A.selectedNode;if(bi){bi.set(a4,false);}A.selectedNode=null;},_afterKeyEvent:function(bi){var A=this;if(bi.hasModifier()||aB.getDoc().get(ap).test(":input,td")){return;}if(bi.isKey(a)){A._onEscKey(bi);}else{if(bi.isKey(E)||bi.isKey(ah)){A._onDeleteKey(bi);}}},_onCancel:function(bi){var A=this;A.closeEditProperties();},_onDeleteKey:function(bi){var A=this;A.deleteSelectedConnectors();A.deleteSelectedNode();bi.halt();},_onDrag:function(bj){var A=this;var bi=bj.target;if(A.isFieldsDrag(bi)){var bk=aB.Widget.getByNode(bi.get(aX));bk.alignTransitions();bg.each(A.getSourceNodes(bk),function(bl){bl.alignTransitions();});}},_onDragEnd:function(bj){var A=this;var bi=bj.target;var bk=aB.Widget.getByNode(bi.get(aX));if(bk&&A.isFieldsDrag(bi)){bk.set(D,bk.getLeftTop());}},_onDropHit:function(bj){var A=this;var bi=bj.drag;if(A.isAvailableFieldsDrag(bi)){var bl=bi.get(r).getData(ac);var bk=A.addField({xy:aE(bi.lastXY,A.dropContainer),type:bl.get(g)});A.select(bk);}},_onEscKey:function(bi){var A=this;A.hideSuggestConnetorOverlay();A.stopEditing();bi.halt();},_onCanvasClick:function(bi){var A=this;A.stopEditing();A.hideSuggestConnetorOverlay();},_onNodeClick:function(bi){var A=this;var bj=aB.Widget.getByNode(bi.currentTarget);A.select(bj);A._onNodeEdit(bi);bi.stopPropagation();},_onNodeEdit:function(bi){var A=this;if(!bi.target.ancestor(i+b,true)){return;
}var bj=aB.Widget.getByNode(bi.currentTarget);if(bj){A.editNode(bj);}},_onNodeMouseEnter:function(bi){var A=this;var bj=aB.Widget.getByNode(bi.currentTarget);bj.set(c,true);},_onNodeMouseLeave:function(bj){var A=this;var bi=A.publishedSource;var bk=aB.Widget.getByNode(bj.currentTarget);if(!bi||!bi.boundaryDragDelegate.dd.get(ae)){bk.set(c,false);}},_onSave:function(bk){var A=this;var bi=A.editingNode;var bl=A.editingConnector;var bj=A.propertyList.get(aL);if(bi){bj.each(function(bm){bi.set(bm.get(a2),bm.get(bb));});}else{if(bl){bj.each(function(bm){bl.set(bm.get(a2),bm.get(bb));});}}},_onSuggestConnectorNodeClick:function(bk){var A=this;var bl=bk.currentTarget.getData(ac);var bi=A.connector;var bj=A.addField({type:bl.get(g),xy:bi.toCoordinate(bi.get(aG))});A.hideSuggestConnetorOverlay();A.publishedSource.connectNode(bj);},_renderGraphic:function(){var A=this;var bj=A.get(al);var bi=A.get(ax);bj.render(bi);aB.one(bi).on(aQ,aB.bind(A._onCanvasClick,A));},_setConnector:function(bj){var A=this;if(!I(bj)){var bi=A.get(ax).getXY();bj=new aB.Connector(aB.merge({builder:A,graphic:A.get(al),lazyDraw:true,p1:bi,p2:bi,shapeHover:null,showName:false},bj));}return bj;},_setFieldsDragConfig:function(bj){var A=this;var bi=A.dropContainer;return aB.merge({bubbleTargets:A,container:bi,dragConfig:{plugins:[{cfg:{constrain:bi},fn:aB.Plugin.DDConstrained},{cfg:{scrollDelay:150},fn:aB.Plugin.DDWinScroll}]},nodes:i+aq},bj||{});},_setSuggestConnectorOverlay:function(bj){var A=this;if(!bj){var bi=aB.getDoc().invoke(T);bg.each(A.get(af),function(bl){var bk=bl.get(r);bi.appendChild(bk.clone().setData(ac,bk.getData(ac)));});bj=new aB.Overlay({bodyContent:bi,render:true,visible:false,zIndex:10000});bj.get(s).delegate(aQ,aB.bind(A._onSuggestConnectorNodeClick,A),i+a3);}return bj;},_setupFieldsDrag:function(){var A=this;A.fieldsDrag=new aB.DD.Delegate(A.get(aD));}}});aB.DiagramBuilder=F;aB.DiagramBuilder.types={};var aj=aB.Component.create({NAME:a9,EXTENDS:aB.Base});aB.DiagramNodeManager=new aj();var bh=aB.Component.create({NAME:G,UI_ATTRS:[c,p,P,a4],ATTRS:{builder:{validator:ai},connectors:{valueFn:"_createDataSet",writeOnce:true},controlsToolbar:{validator:N,valueFn:"_valueControlsToolbar"},description:{value:aa,validator:a5},graphic:{writeOnce:true,validator:N},height:{value:60},highlighted:{validator:a0,value:false},name:{valueFn:function(){var A=this;return A.get(g)+(++aB.Env._uidx);},validator:a5},required:{value:false,validator:a0},selected:{value:false,validator:a0},shapeBoundary:{validator:N,valueFn:"_valueShapeBoundary"},highlightBoundaryStroke:{validator:N,value:{weight:7,color:"#484B4C",opacity:0.25}},shapeInvite:{validator:N,value:{radius:12,type:"circle",stroke:{weight:6,color:"#ff6600",opacity:0.8},fill:{color:"#ffd700",opacity:0.8}}},strings:{value:{closeMessage:"Close",connectMessage:"Connect",description:"Description",editMessage:"Edit",name:"Name",type:"Type"}},tabIndex:{value:1},transitions:{value:null,writeOnce:true,setter:"_setTransitions"},type:{value:r,validator:a5},width:{value:60},zIndex:{value:100}},EXTENDS:aB.Overlay,CIRCLE_POINTS:[[35,20],[28,33],[14,34],[5,22],[10,9],[24,6],[34,16],[31,30],[18,35],[6,26],[7,12],[20,5],[33,12],[34,26],[22,35],[9,30],[6,16],[16,6],[30,9],[35,22],[26,34],[12,33],[5,20],[12,7],[26,6],[35,18],[30,31],[16,34],[6,24],[9,10],[22,5],[34,14],[33,28],[20,35],[7,28],[6,14],[18,5],[31,10],[34,24],[24,34],[10,31],[5,18],[14,6],[28,8],[35,20],[28,33],[14,34],[5,22],[10,8],[25,6],[34,16],[31,30],[18,35],[6,26],[8,12],[20,5],[33,12],[33,27],[22,35],[8,30],[6,15],[16,6],[30,9],[35,23],[26,34],[12,32],[5,20],[12,7],[27,7],[35,18],[29,32],[15,34]],DIAMOND_POINTS:[[30,5],[35,10],[40,15],[45,20],[50,25],[55,30],[50,35],[45,40],[40,45],[35,50],[30,55],[25,50],[20,45],[15,40],[10,35],[5,30],[10,25],[15,20],[20,15],[25,10]],SQUARE_POINTS:[[5,5],[10,5],[15,5],[20,5],[25,5],[30,5],[35,5],[40,5],[50,5],[55,5],[60,5],[65,5],[65,10],[65,15],[65,20],[65,25],[65,30],[65,35],[65,40],[65,45],[65,50],[65,55],[65,60],[65,65],[60,65],[55,65],[50,65],[45,65],[40,65],[35,65],[30,65],[25,65],[20,65],[15,65],[10,65],[5,65],[5,60],[5,55],[5,50],[5,45],[5,40],[5,35],[5,30],[5,25],[5,20],[5,15],[5,10]],getNodeByName:function(A){return aB.Widget.getByNode("[data-nodeId="+bh.buildNodeId(A)+"]");},buildNodeId:function(A){return aF+M+aZ+M+A.replace(/[^a-z0-9.:_\-]/ig,"_");},prototype:{LABEL_TEMPLATE:'<div class="'+ad+'">{label}</div>',boundary:null,hotPoints:[[0,0]],CONTROLS_TEMPLATE:'<div class="'+w+'"></div>',SERIALIZABLE_ATTRS:[aT,p,P,g,U,aY,C,D],initializer:function(){var A=this;A.after({"dataset:remove":aB.bind(A._afterDataSetRemove,A),render:A._afterRender});A.on({nameChange:A._onNameChange});A.publish({connectDrop:{defaultFn:A.connectDrop},connectEnd:{defaultFn:A.connectEnd},connectMove:{defaultFn:A.connectMove},connectOutTarget:{defaultFn:A.connectOutTarget},connectOverTarget:{defaultFn:A.connectOverTarget},connectStart:{defaultFn:A.connectStart},boundaryMouseEnter:{},boundaryMouseLeave:{}});A.get(s).addClass(aq+bf+A.get(g));},destructor:function(){var A=this;A.eachConnector(function(bi,bj,bk){bk.removeTransition(bi.get(o));});A.invite.destroy();A.get(al).destroy();A.get(bc).removeField(A);},addTransition:function(bj){var A=this;var bi=A.get(ab);bj=A.prepareTransition(bj);if(!bi.containsKey(bj.uid)){bj.uid=aB.guid();bi.add(bj.uid,bj);}return bj;},alignTransition:function(bj){var A=this;var bk=aB.DiagramNode.getNodeByName(bj.target);if(bk){var bi=ak(A,bk);bj=aB.merge(bj,{sourceXY:bi[0],targetXY:bi[1]});A.getConnector(bj).setAttrs({p1:au(A,bj.sourceXY),p2:au(bk,bj.targetXY)});}},alignTransitions:function(){var A=this;A.get(ab).each(aB.bind(A.alignTransition,A));},close:function(){var A=this;return A.destroy();},connect:function(bm,bk){var A=this;bm=A.addTransition(bm);var bi=null;var bn=aB.DiagramNode.getNodeByName(bm.target);if(bn){if(!A.isTransitionConnected(bm)){var bj=A.get(bc);var bl=ak(A,bn);aB.mix(bm,{sourceXY:bl[0],targetXY:bl[1]});bi=new aB.Connector(aB.merge({builder:bj,graphic:bj.get(al),transition:bm},bk));
A.get(m).add(bm.uid,bi);}}A.alignTransition(bm);return bi;},connectDrop:function(bi){var A=this;A.connectNode(bi.publishedTarget);},connectEnd:function(bl){var A=this;var bk=bl.target;var bi=A.get(bc);var bj=bi.publishedSource;if(!bi.isAbleToConnect()&&bi.get(O)&&bi.connector.get(at)){bi.showSuggestConnetorOverlay();}else{bi.connector.hide();bj.invite.set(at,false);}if(bi.get(R)){bi.get(t).each(function(bm){bm.set(c,false);});}},connectMove:function(bk){var A=this;var bj=A.get(bc);var bl=bk.mouseXY;bj.connector.set(aG,bl);if(bj.publishedTarget){var bi=A.invite;var bm=bi.get(aM)||0;if(!bi.get(at)){bi.set(at,true);}bi.setXY([bl[0]-bm,bl[1]-bm]);}},connectNode:function(bj){var bi=this;var A=bi.boundaryDragDelegate.dd;bi.connect(bi.prepareTransition({sourceXY:aE(A.startXY,bi.get(s)),target:bj.get(p),targetXY:aE(A.mouseXY,bj.get(s))}));},connectOutTarget:function(bj){var A=this;var bi=A.get(bc);bi.publishedTarget=null;bi.publishedSource.invite.set(at,false);},connectOverTarget:function(bj){var A=this;var bi=A.get(bc);if(bi.publishedSource!==A){bi.publishedTarget=A;}},connectStart:function(bk){var A=this;var bi=A.get(bc);var bj=bi.get(ax);bi.connector.show().set(aI,bk.startXY);if(bi.get(R)){bi.get(t).each(function(bl){bl.set(c,true);});}aB.DiagramNodeManager.fire("publishedSource",{publishedSource:A});},disconnect:function(bi){var A=this;if(A.isTransitionConnected(bi)){A.removeTransition(bi);}},eachConnector:function(bk){var A=this;var bl=[],bi=[].concat(A.get(m).values),bj=bi.length;bg.each(A.get(bc).getSourceNodes(A),function(bm){bm.get(m).each(function(bn){if(A.get(p)===bn.get(o).target){bl.push(bm);bi.push(bn);}});});bg.each(bi,function(bm,bn){bk.call(A,bm,bn,(bn<bj)?A:bl[bn-bj]);});bi=bl=null;return bi;},getConnector:function(bi){var A=this;return A.get(m).item(bi.uid);},getContainer:function(){var A=this;return(A.get(bc).dropContainer||A.get(s).get(f));},getLeftTop:function(){var A=this;return aE(A.get(s),A.getContainer());},getProperties:function(){var A=this;var bi=A.getPropertyModel();bg.each(bi,function(bl){var bk=A.get(bl.attributeName),bj=ar.type(bk);if(bj===an){bk=String(bk);}bl.value=bk;});return bi;},getPropertyModel:function(){var bi=this;var A=bi.getStrings();return[{attributeName:aT,editor:new aB.TextAreaCellEditor(),name:A[aT]},{attributeName:p,editor:new aB.TextCellEditor({validator:{rules:{value:{required:true}}}}),name:A[p]},{attributeName:g,editor:false,name:A[g]}];},isBoundaryDrag:function(bi){var A=this;return(bi===A.boundaryDragDelegate.dd);},isTransitionConnected:function(bi){var A=this;return A.get(m).containsKey(bi.uid);},prepareTransition:function(bj){var A=this;var bi={source:A.get(p),target:null,uid:aB.guid()};if(a5(bj)){bi.target=bj;}else{if(N(bj)){bi=aB.merge(bi,bj);}}return bi;},removeTransition:function(bi){var A=this;return A.get(ab).removeKey(bi.uid);},renderShapeBoundary:function(){var A=this;var bi=A.boundary=A.get(al).addShape(A.get(ag));return bi;},renderShapeInvite:function(){var A=this;var bi=A.invite=A.get(bc).get(al).addShape(A.get(j));bi.set(at,false);return bi;},syncConnectionsUI:function(){var A=this;A.get(ab).each(function(bi){A.connect(bi,bi.connector);});},_afterDataSetRemove:function(bj){var A=this;var bi=bj.target;if(bi===A.get(ab)){A.get(m).removeKey(bj.prevVal.uid);}else{if(bi===A.get(m)){bj.prevVal.destroy();}}},_afterRender:function(bi){var A=this;A.setStdModContent(aw.BODY,aa,aw.AFTER);A._renderGraphic();A._renderControls();A._renderLabel();A._uiSetHighlighted(A.get(c));},_bindBoundaryEvents:function(){var A=this;A.boundary.detachAll().on({mouseenter:aB.bind(A._onBoundaryMouseEnter,A),mouseleave:aB.bind(A._onBoundaryMouseLeave,A)});},_createDataSet:function(){var A=this;return new aB.DataSet({bubbleTargets:A});},_handleCloseEvent:function(bi){var A=this;A.get(bc).deleteSelectedNode();},_handleConnectStart:function(bi){var A=this;A.fire("connectStart",{startXY:bi});},_handleConnectMove:function(bj){var A=this;var bi=A.get(bc);A.fire("connectMove",{mouseXY:bj,publishedSource:bi.publishedSource});},_handleConnectEnd:function(){var A=this;var bi=A.get(bc);var bj=bi.publishedSource;var bk=bi.publishedTarget;if(bj&&bk){A.fire("connectDrop",{publishedSource:bj,publishedTarget:bk});}A.fire("connectEnd",{publishedSource:bj});},_handleConnectOutTarget:function(bk){var A=this;var bi=A.get(bc);var bj=bi.publishedSource;if(bj){A.fire("connectOutTarget",{publishedSource:bj});}},_handleConnectOverTarget:function(){var A=this;var bi=A.get(bc);var bj=bi.publishedSource;if(bj){A.fire("connectOverTarget",{publishedSource:bj});}},_handleEditEvent:function(bi){var A=this;A.get(bc).editNode(A);},_onBoundaryDrag:function(bj){var bi=this;var A=bi.boundaryDragDelegate.dd;bi._handleConnectMove(A.con._checkRegion(A.mouseXY));},_onBoundaryDragEnd:function(bi){var A=this;A._handleConnectEnd();bi.target.get(aX).show();},_onBoundaryDragStart:function(bi){var A=this;A._handleConnectStart(A.boundaryDragDelegate.dd.startXY);bi.target.get(aX).hide();},_onBoundaryMouseEnter:function(bi){var A=this;A.fire("boundaryMouseEnter",{domEvent:bi});A._handleConnectOverTarget();},_onBoundaryMouseLeave:function(bi){var A=this;A.fire("boundaryMouseLeave",{domEvent:bi});A._handleConnectOutTarget();},_onNameChange:function(bi){var A=this;A.eachConnector(function(bj,bk,bl){var bm=bj.get(o);bm[(A===bl)?Y:l]=bi.newVal;bj.set(o,bm);});},_renderControls:function(){var A=this;var bi=A.get(s);A.controlsNode=aB.Node.create(A.CONTROLS_TEMPLATE).appendTo(bi);},_renderControlsToolbar:function(bi){var A=this;A.controlsToolbar=new aB.Toolbar(A.get(aN)).render(A.controlsNode);A._uiSetRequired(A.get(P));},_renderGraphic:function(){var A=this;A.set(al,new aB.Graphic({height:A.get(aY),render:A.bodyNode,width:A.get(U)}));A.renderShapeInvite();A.renderShapeBoundary().addClass(aU);A._bindBoundaryEvents();A._setupBoundaryDrag();},_renderLabel:function(){var A=this;A.labelNode=aB.Node.create(ar.sub(A.LABEL_TEMPLATE,{label:A.get("name")}));A.get("contentBox").placeAfter(A.labelNode);},_setTransitions:function(bj){var A=this;
if(!a7(bj)){var bi=A._createDataSet();aB.Array.each(bj,function(bl){var bk=aB.guid();bl=N(bl)?aB.mix(bl,{uid:bk}):{uid:bk,target:bl};bi.add(bk,A.prepareTransition(bl));});bj=bi;}return bj;},_setupBoundaryDrag:function(){var A=this;var bi=A.get(bc);A.boundaryDragDelegate=new aB.DD.Delegate({bubbleTargets:A,container:A.bodyNode,nodes:i+aU,dragConfig:{useShim:false,plugins:[{cfg:{constrain:(bi?bi.get(ax):null)},fn:aB.Plugin.DDConstrained},{cfg:{scrollDelay:150},fn:aB.Plugin.DDWinScroll},{cfg:{borderStyle:"0px",moveOnEnd:false,resizeFrame:false},fn:aB.Plugin.DDProxy}]},on:{"drag:drag":aB.bind(A._onBoundaryDrag,A),"drag:end":aB.bind(A._onBoundaryDragEnd,A),"drag:start":aB.bind(A._onBoundaryDragStart,A)}});aB.Do.after(A._bindBoundaryEvents,A.boundaryDragDelegate.dd,"_unprep",A);},_uiSetHighlighted:function(bj){var A=this;if(A.get(bd)){var bi=bj?A.get(aH):A.get(ag+i+x);if(bi){A.boundary.set(x,bi);}}},_uiSetName:function(bj){var A=this;var bi=A.get(s);bi.setAttribute(W,bh.buildNodeId(bj));if(A.get("rendered")){A.labelNode.setContent(bj);}},_uiSetRequired:function(bk){var bj=this;var bi=bj.controlsToolbar;var bl=bj.get(aP);var A=bj.getStrings();if(bi){if(bk){bi.remove(bl+M+a6);}else{bi.add({handler:aB.bind(bj._handleCloseEvent,bj),icon:av,id:bl+M+a6,title:A[K]});}}},_uiSetSelected:function(bi){var A=this;A.get(s).toggleClass(be,bi);if(bi&&!A.controlsToolbar){A._renderControlsToolbar();}},_uiSetXY:function(bj){var A=this;var bi=A.getContainer().getXY();this._posNode.setXY([bj[0]+bi[0],bj[1]+bi[1]]);},_valueControlsToolbar:function(bj){var bi=this;var bk=bi.get(aP);var A=bi.getStrings();return{activeState:false,children:[{handler:aB.bind(bi._handleEditEvent,bi),icon:n,id:bk+M+H,title:A[Q]},{handler:aB.bind(bi._handleCloseEvent,bi),icon:av,id:bk+M+a6,title:A[K]}]};},_valueShapeBoundary:function(){var A=this;return{height:41,type:"rect",stroke:{weight:7,color:"transparent",opacity:0},width:41};}}});aB.DiagramNode=bh;aB.DiagramBuilder.types[r]=aB.DiagramNode;aB.DiagramNodeState=aB.Component.create({NAME:G,ATTRS:{height:{value:40},type:{value:am},width:{value:40}},EXTENDS:aB.DiagramNode,prototype:{hotPoints:aB.DiagramNode.CIRCLE_POINTS,renderShapeBoundary:function(){var A=this;var bi=A.boundary=A.get(al).addShape(A.get(ag));bi.translate(5,5);return bi;},_valueShapeBoundary:function(){var A=this;return{radius:15,type:"circle",stroke:{weight:7,color:"transparent",opacity:0}};}}});aB.DiagramBuilder.types[am]=aB.DiagramNodeState;aB.DiagramNodeCondition=aB.Component.create({NAME:G,ATTRS:{height:{value:60},type:{value:a8},width:{value:60}},EXTENDS:aB.DiagramNodeState,prototype:{hotPoints:aB.DiagramNode.DIAMOND_POINTS,renderShapeBoundary:function(){var A=this;var bi=A.boundary=A.get(al).addShape(A.get(ag));bi.translate(10,10);bi.rotate(45);return bi;},_valueShapeBoundary:aB.DiagramNode.prototype._valueShapeBoundary}});aB.DiagramBuilder.types[a8]=aB.DiagramNodeCondition;aB.DiagramNodeStart=aB.Component.create({NAME:G,ATTRS:{type:{value:aK}},EXTENDS:aB.DiagramNodeState});aB.DiagramBuilder.types[aK]=aB.DiagramNodeStart;aB.DiagramNodeEnd=aB.Component.create({NAME:G,ATTRS:{type:{value:aS}},EXTENDS:aB.DiagramNodeState});aB.DiagramBuilder.types[aS]=aB.DiagramNodeEnd;aB.DiagramNodeJoin=aB.Component.create({NAME:G,ATTRS:{height:{value:60},type:{value:v},width:{value:60}},EXTENDS:aB.DiagramNodeState,prototype:{hotPoints:aB.DiagramNode.DIAMOND_POINTS,renderShapeBoundary:aB.DiagramNodeCondition.prototype.renderShapeBoundary,_valueShapeBoundary:aB.DiagramNode.prototype._valueShapeBoundary}});aB.DiagramBuilder.types[v]=aB.DiagramNodeJoin;aB.DiagramNodeFork=aB.Component.create({NAME:G,ATTRS:{height:{value:60},type:{value:aA},width:{value:60}},EXTENDS:aB.DiagramNodeState,prototype:{hotPoints:aB.DiagramNode.DIAMOND_POINTS,renderShapeBoundary:aB.DiagramNodeCondition.prototype.renderShapeBoundary,_valueShapeBoundary:aB.DiagramNode.prototype._valueShapeBoundary}});aB.DiagramBuilder.types[aA]=aB.DiagramNodeFork;aB.DiagramNodeTask=aB.Component.create({NAME:G,ATTRS:{height:{value:70},type:{value:J},width:{value:70}},EXTENDS:aB.DiagramNodeState,prototype:{hotPoints:aB.DiagramNode.SQUARE_POINTS,renderShapeBoundary:function(){var A=this;var bi=A.boundary=A.get(al).addShape(A.get(ag));bi.translate(8,8);return bi;},_valueShapeBoundary:function(){var A=this;return{height:55,type:"rect",stroke:{weight:7,color:"transparent",opacity:0},width:55};}}});aB.DiagramBuilder.types[J]=aB.DiagramNodeTask;},"@VERSION@",{skinnable:true,requires:["aui-data-set","aui-diagram-builder-base","aui-diagram-builder-connector","overlay"]});AUI.add("aui-diagram-builder-connector",function(i){var T=i.Lang,s=T.isArray,w=T.isBoolean,E=T.isObject,g=T.isString,o=i.Array,R=function(A){return(A*A*A);},Q=function(A){return(3*A*A*(1-A));},P=function(A){return(3*A*(1-A)*(1-A));},N=function(A){return((1-A)*(1-A)*(1-A));},l=function(X,W,V,Z,Y){var A=W[0]*R(X)+Z[0]*Q(X)+Y[0]*P(X)+V[0]*N(X);var aa=W[1]*R(X)+Z[1]*Q(X)+Y[1]*P(X)+V[1]*N(X);return[A,aa];},H=function(A){return i.instanceOf(A,i.Graphic);},d=function(A){return A*180/Math.PI;},h=function(A){return A===0?0:(A<0?-1:1);},K="arrowPoints",M="boundingBox",U="builder",F="click",y="color",q="connector",t="diagramNode",B="fill",z="graphic",G="helper",J="hidden",O="lazyDraw",c="mouseenter",j="mouseleave",x="name",I="nodeName",n="p1",m="p2",e="path",v="region",u="selected",r="shape",b="shapeArrow",p="shapeArrowHover",L="shapeArrowSelected",C="shapeHover",k="shapeSelected",D="showName",f="stroke",S="visible",a=i.getClassName(G,J);i.PolygonUtil={ARROW_POINTS:[[-12,-6],[-8,0],[-12,6],[6,0]],drawArrow:function(W,X,Z,V,Y,aa){var A=this;var ab=Math.atan2(Y-Z,V-X);W.moveTo(V,Y);V=V-5*Math.cos(ab);Y=Y-5*Math.sin(ab);A.drawPolygon(W,A.translatePoints(A.rotatePoints(aa||A.ARROW_POINTS,ab),V,Y));},drawPolygon:function(V,W){var A=this;V.moveTo(W[0][0],W[0][1]);o.each(W,function(Y,X){if(X>0){V.lineTo(W[X][0],W[X][1]);}});V.lineTo(W[0][0],W[0][1]);},translatePoints:function(W,V,Y){var A=this;var X=[];o.each(W,function(aa,Z){X.push([W[Z][0]+V,W[Z][1]+Y]);
});return X;},rotatePoints:function(V,X){var A=this;var W=[];o.each(V,function(Z,Y){W.push(A.rotatePoint(X,V[Y][0],V[Y][1]));});return W;},rotatePoint:function(V,A,W){return[(A*Math.cos(V))-(W*Math.sin(V)),(A*Math.sin(V))+(W*Math.cos(V))];}};i.Connector=i.Base.create("line",i.Base,[],{SERIALIZABLE_ATTRS:[y,O,x,k,C,n,m],shape:null,shapeArrow:null,initializer:function(W){var A=this;var V=A.get(O);A.after({nameChange:A._afterNameChange,p1Change:A.draw,p2Change:A.draw,selectedChange:A._afterSelectedChange,showNameChange:A._afterShowNameChange,visibleChange:A._afterVisibleChange});A._initShapes();if(!V){A.draw();}A._uiSetVisible(A.get(S));A._uiSetName(A.get(x));A._uiSetSelected(A.get(u),!V);A._uiSetShowName(A.get(D));},destructor:function(){var A=this;A.shape.destroy();A.shapeArrow.destroy();A.get(I).remove();},draw:function(){var ao=this;var X=ao.shape;var A=ao.shapeArrow;var W=ao.get(n),V=ao.get(m),ak=ao.toCoordinate(W),ai=ao.toCoordinate(V),am=ak[0],Z=ak[1],al=ai[0],Y=ai[1],af=Math.max(Math.abs(am-al)/2,10),ad=Math.max(Math.abs(Z-Y)/2,10),ac=null,ae=8,an=d(Math.atan2(Y-Z,al-am)),aa=Math.round(Math.abs(an)/(360/ae));if(h(an)<0){ac=[[am+af,Z,al-af,Y,al,Y],[am+af,Z,al,Z-ad,al,Y],[am,Z-ad,al,Z-ad,al,Y],[am-af,Z,al,Z-ad,al,Y],[am-af,Z,al+af,Y,al,Y]];}else{ac=[[am+af,Z,al-af,Y,al,Y],[am+af,Z,al,Z+ad,al,Y],[am,Z+ad,al,Z+ad,al,Y],[am-af,Z,al,Z+ad,al,Y],[am-af,Z,al+af,Y,al,Y]];}var ab=ac[aa];X.clear();X.moveTo(am,Z);X.curveTo.apply(X,ab);X.end();var ah=l(0,[am,Z],[al,Y],[ab[0],ab[1]],[ab[2],ab[3]]),ag=l(0.075,[am,Z],[al,Y],[ab[0],ab[1]],[ab[2],ab[3]]),aj=l(0.5,[am,Z],[al,Y],[ab[0],ab[1]],[ab[2],ab[3]]);A.clear();i.PolygonUtil.drawArrow(A,ag[0],ag[1],ah[0],ah[1],ao.get(K));A.end();if(ao.get(D)){ao.get(I).center(ao.toXY(aj));}return ao;},getProperties:function(){var A=this;var V=A.getPropertyModel();o.each(V,function(W){W.value=A.get(W.attributeName);});return V;},getPropertyModel:function(){var V=this;var A=V.getStrings();return[{attributeName:x,editor:new i.TextCellEditor({validator:{rules:{value:{required:true}}}}),name:A[x]}];},getStrings:function(){return i.Connector.STRINGS;},hide:function(){var A=this;A.set(S,false);return A;},show:function(){var A=this;A.set(S,true);return A;},toCoordinate:function(V){var A=this;return A._offsetXY(V,-1);},toJSON:function(){var A=this;var V={};o.each(A.SERIALIZABLE_ATTRS,function(W){V[W]=A.get(W);});return V;},toXY:function(V){var A=this;return A._offsetXY(V,1);},_afterNameChange:function(V){var A=this;A._uiSetName(V.newVal);A.draw();},_afterSelectedChange:function(V){var A=this;A._uiSetSelected(V.newVal);},_afterShowNameChange:function(V){var A=this;A._uiSetShowName(V.newVal);},_afterVisibleChange:function(V){var A=this;A._uiSetVisible(V.newVal);},_initShapes:function(){var A=this;var V=A.shape=A.get(z).addShape(A.get(r));var W=A.shapeArrow=A.get(z).addShape(A.get(b));V.on(F,i.bind(A._onShapeClick,A));V.on(c,i.bind(A._onShapeMouseEnter,A));V.on(j,i.bind(A._onShapeMouseLeave,A));W.on(F,i.bind(A._onShapeClick,A));A.get(I).on(F,i.bind(A._onShapeClick,A));},_offsetXY:function(X,W){var A=this;var V=A.get(z).getXY();return[X[0]+V[0]*W,X[1]+V[1]*W];},_onShapeClick:function(X){var A=this;var V=A.get(U);var W=A.get(u);if(V){if(X.hasModifier()){V.closeEditProperties();}else{V.unselectConnectors();if(W){V.closeEditProperties();}else{V.editConnector(A);}}}A.set(u,!W);X.halt();},_onShapeMouseEnter:function(X){var A=this;if(!A.get(u)){var W=A.get(C);var V=A.get(p);if(W){A._updateShape(A.shape,W);}if(V){A._updateShape(A.shapeArrow,V);}}},_onShapeMouseLeave:function(V){var A=this;if(!A.get(u)){A._updateShape(A.shape,A.get(r));A._updateShape(A.shapeArrow,A.get(b));}},_setNodeName:function(V){var A=this;if(!i.instanceOf(V,i.Node)){V=new i.Template(V).render();A.get(U).canvas.append(V.unselectable());}return V;},_setShape:function(V){var A=this;return i.merge({type:e,stroke:{color:A.get(y),weight:2,opacity:1}},V);},_setShapeArrow:function(V){var A=this;return i.merge({type:e,fill:{color:A.get(y),opacity:1},stroke:{color:A.get(y),weight:2,opacity:1}},V);},_uiSetName:function(V){var A=this;A.get(I).html(V);},_uiSetSelected:function(W,V){var A=this;A._updateShape(A.shape,W?A.get(k):A.get(r),V);A._updateShape(A.shapeArrow,W?A.get(L):A.get(b),V);},_uiSetShowName:function(V){var A=this;A.get(I).toggleClass(a,!V);},_uiSetVisible:function(V){var A=this;A.shape.set(S,V);A.shapeArrow.set(S,V);A._uiSetShowName(V&&A.get(D));},_updateShape:function(W,X,V){var A=this;if(X.hasOwnProperty(B)){W.set(B,X[B]);}if(X.hasOwnProperty(f)){W.set(f,X[f]);}if(V!==false){A.draw();}}},{ATTRS:{arrowPoints:{value:i.PolygonUtil.ARROW_POINTS},builder:{},color:{value:"#27aae1",validator:g},graphic:{validator:H},lazyDraw:{value:false,validator:w},name:{valueFn:function(){var A=this;return q+(++i.Env._uidx);},validator:g},nodeName:{setter:"_setNodeName",value:['<span class="{$ans}diagram-builder-connector-name"></span>'],writeOnce:true},p1:{value:[0,0],validator:s},p2:{value:[0,0],validator:s},selected:{value:false,validator:w},shape:{value:null,setter:"_setShape"},shapeArrow:{value:null,setter:"_setShapeArrow"},shapeArrowHover:{value:{fill:{color:"#ffd700"},stroke:{color:"#ffd700",weight:5,opacity:0.8}}},shapeArrowSelected:{value:{fill:{color:"#ff6600"},stroke:{color:"#ff6600",weight:5,opacity:0.8}}},shapeHover:{value:{stroke:{color:"#ffd700",weight:5,opacity:0.8}}},shapeSelected:{value:{stroke:{color:"#ff6600",weight:5,opacity:0.8}}},showName:{validator:w,value:true},transition:{value:{},validator:E},visible:{validator:w,value:true}},STRINGS:{name:"Name"}});},"@VERSION@",{skinnable:true,requires:["aui-base","aui-template","arraylist-add","arraylist-filter","json","graphics","dd"]});AUI.add("aui-diagram-builder",function(a){},"@VERSION@",{skinnable:true,use:["aui-diagram-builder-base","aui-diagram-builder-impl"]});